{"ast":null,"code":"// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\nimport { getCurrentTimestampInMs } from \"../utils/time\";\n/**\n * @hidden\n * Internal class to hold CosmosDiagnostic aggregate information all through the lifecycle of a request.\n * This object gathers diagnostic information throughout Client operation which may span across multiple\n * Server call, retries etc.\n * Functions - recordFailedAttempt, recordMetaDataQuery, recordEndpointContactEvent are used to ingest\n * data into the context. At the end of operation, getDiagnostics() is used to\n * get final CosmosDiagnostic object.\n */\nexport class CosmosDiagnosticContext {\n  constructor() {\n    this.failedAttempts = [];\n    this.metadataLookups = [];\n    this.gaterwayStatistics = [];\n    this.locationEndpointsContacted = new Set();\n    this.requestStartTimeUTCinMs = getCurrentTimestampInMs();\n  }\n  recordFailedAttempt(gaterwayStatistics, retryAttemptNumber) {\n    const attempt = {\n      attemptNumber: retryAttemptNumber,\n      startTimeUTCInMs: gaterwayStatistics.startTimeUTCInMs,\n      durationInMs: gaterwayStatistics.durationInMs,\n      statusCode: gaterwayStatistics.statusCode,\n      substatusCode: gaterwayStatistics.subStatusCode,\n      requestPayloadLengthInBytes: gaterwayStatistics.requestPayloadLengthInBytes,\n      responsePayloadLengthInBytes: gaterwayStatistics.responsePayloadLengthInBytes,\n      activityId: gaterwayStatistics.activityId,\n      operationType: gaterwayStatistics.operationType,\n      resourceType: gaterwayStatistics.resourceType\n    };\n    this.failedAttempts.push(attempt);\n  }\n  recordNetworkCall(gaterwayStatistics) {\n    this.gaterwayStatistics.push(gaterwayStatistics);\n  }\n  /**\n   * Merge given DiagnosticContext to current node's DiagnosticContext, Treating GatewayRequests of\n   * given DiagnosticContext, as metadata requests.\n   */\n  mergeDiagnostics(childDiagnostics, metadataType) {\n    // Copy Location endpoints contacted.\n    childDiagnostics.locationEndpointsContacted.forEach(endpoint => this.locationEndpointsContacted.add(endpoint));\n    // Copy child nodes's GatewayStatistics to parent's metadata lookups.\n    childDiagnostics.gaterwayStatistics.forEach(gateway => this.metadataLookups.push({\n      activityId: gateway.activityId,\n      requestPayloadLengthInBytes: gateway.requestPayloadLengthInBytes,\n      responsePayloadLengthInBytes: gateway.responsePayloadLengthInBytes,\n      startTimeUTCInMs: gateway.startTimeUTCInMs,\n      operationType: gateway.operationType,\n      resourceType: gateway.resourceType,\n      durationInMs: gateway.durationInMs,\n      metaDataType: metadataType\n    }));\n    // Copy child nodes's metadata lookups to parent's metadata lookups.\n    childDiagnostics.metadataLookups.forEach(lookup => this.metadataLookups.push(lookup));\n    // Copy child nodes's failed attempts to parent's failed attempts.\n    childDiagnostics.failedAttempts.forEach(lookup => this.failedAttempts.push(lookup));\n  }\n  getClientSideStats(endTimeUTCInMs = getCurrentTimestampInMs()) {\n    return {\n      requestStartTimeUTCInMs: this.requestStartTimeUTCinMs,\n      requestDurationInMs: endTimeUTCInMs - this.requestStartTimeUTCinMs,\n      totalRequestPayloadLengthInBytes: this.getTotalRequestPayloadLength(),\n      totalResponsePayloadLengthInBytes: this.getTotalResponsePayloadLength(),\n      locationEndpointsContacted: [...this.locationEndpointsContacted.values()],\n      metadataDiagnostics: {\n        metadataLookups: [...this.metadataLookups]\n      },\n      retryDiagnostics: {\n        failedAttempts: [...this.failedAttempts]\n      },\n      gatewayStatistics: this.gaterwayStatistics\n    };\n  }\n  getTotalRequestPayloadLength() {\n    let totalRequestPayloadLength = 0;\n    this.gaterwayStatistics.forEach(req => totalRequestPayloadLength += req.requestPayloadLengthInBytes);\n    this.metadataLookups.forEach(req => totalRequestPayloadLength += req.requestPayloadLengthInBytes);\n    this.failedAttempts.forEach(req => totalRequestPayloadLength += req.requestPayloadLengthInBytes);\n    return totalRequestPayloadLength;\n  }\n  getTotalResponsePayloadLength() {\n    let totalResponsePayloadLength = 0;\n    this.gaterwayStatistics.forEach(req => totalResponsePayloadLength += req.responsePayloadLengthInBytes);\n    this.metadataLookups.forEach(req => totalResponsePayloadLength += req.responsePayloadLengthInBytes);\n    this.failedAttempts.forEach(req => totalResponsePayloadLength += req.responsePayloadLengthInBytes);\n    return totalResponsePayloadLength;\n  }\n  recordEndpointResolution(location) {\n    this.locationEndpointsContacted.add(location);\n  }\n}","map":{"version":3,"names":["getCurrentTimestampInMs","CosmosDiagnosticContext","constructor","failedAttempts","metadataLookups","gaterwayStatistics","locationEndpointsContacted","Set","requestStartTimeUTCinMs","recordFailedAttempt","retryAttemptNumber","attempt","attemptNumber","startTimeUTCInMs","durationInMs","statusCode","substatusCode","subStatusCode","requestPayloadLengthInBytes","responsePayloadLengthInBytes","activityId","operationType","resourceType","push","recordNetworkCall","mergeDiagnostics","childDiagnostics","metadataType","forEach","endpoint","add","gateway","metaDataType","lookup","getClientSideStats","endTimeUTCInMs","requestStartTimeUTCInMs","requestDurationInMs","totalRequestPayloadLengthInBytes","getTotalRequestPayloadLength","totalResponsePayloadLengthInBytes","getTotalResponsePayloadLength","values","metadataDiagnostics","retryDiagnostics","gatewayStatistics","totalRequestPayloadLength","req","totalResponsePayloadLength","recordEndpointResolution","location"],"sources":["/Users/ajitpawar/microsoft/bap/POCs/Scenario_checker_for_maker/mcs-scenario-checker-for-maker/node_modules/@azure/cosmos/src/diagnostics/CosmosDiagnosticsContext.ts"],"sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport type {\n  ClientSideRequestStatistics,\n  FailedRequestAttemptDiagnostic,\n  GatewayStatistics,\n  MetadataLookUpDiagnostic,\n  MetadataLookUpType,\n} from \"../CosmosDiagnostics\";\nimport { getCurrentTimestampInMs } from \"../utils/time\";\n\n/**\n * @hidden\n * Internal class to hold CosmosDiagnostic aggregate information all through the lifecycle of a request.\n * This object gathers diagnostic information throughout Client operation which may span across multiple\n * Server call, retries etc.\n * Functions - recordFailedAttempt, recordMetaDataQuery, recordEndpointContactEvent are used to ingest\n * data into the context. At the end of operation, getDiagnostics() is used to\n * get final CosmosDiagnostic object.\n */\nexport class CosmosDiagnosticContext {\n  private requestStartTimeUTCinMs: number;\n  private failedAttempts: FailedRequestAttemptDiagnostic[] = [];\n  private metadataLookups: MetadataLookUpDiagnostic[] = [];\n  private gaterwayStatistics: GatewayStatistics[] = [];\n  public locationEndpointsContacted: Set<string> = new Set();\n\n  public constructor() {\n    this.requestStartTimeUTCinMs = getCurrentTimestampInMs();\n  }\n\n  public recordFailedAttempt(\n    gaterwayStatistics: GatewayStatistics,\n    retryAttemptNumber: number,\n  ): void {\n    const attempt: FailedRequestAttemptDiagnostic = {\n      attemptNumber: retryAttemptNumber,\n      startTimeUTCInMs: gaterwayStatistics.startTimeUTCInMs,\n      durationInMs: gaterwayStatistics.durationInMs,\n      statusCode: gaterwayStatistics.statusCode,\n      substatusCode: gaterwayStatistics.subStatusCode,\n      requestPayloadLengthInBytes: gaterwayStatistics.requestPayloadLengthInBytes,\n      responsePayloadLengthInBytes: gaterwayStatistics.responsePayloadLengthInBytes,\n      activityId: gaterwayStatistics.activityId,\n      operationType: gaterwayStatistics.operationType,\n      resourceType: gaterwayStatistics.resourceType,\n    };\n    this.failedAttempts.push(attempt);\n  }\n\n  public recordNetworkCall(gaterwayStatistics: GatewayStatistics): void {\n    this.gaterwayStatistics.push(gaterwayStatistics);\n  }\n\n  /**\n   * Merge given DiagnosticContext to current node's DiagnosticContext, Treating GatewayRequests of\n   * given DiagnosticContext, as metadata requests.\n   */\n  public mergeDiagnostics(\n    childDiagnostics: CosmosDiagnosticContext,\n    metadataType: MetadataLookUpType,\n  ): void {\n    // Copy Location endpoints contacted.\n    childDiagnostics.locationEndpointsContacted.forEach((endpoint) =>\n      this.locationEndpointsContacted.add(endpoint),\n    );\n\n    // Copy child nodes's GatewayStatistics to parent's metadata lookups.\n    childDiagnostics.gaterwayStatistics.forEach((gateway) =>\n      this.metadataLookups.push({\n        activityId: gateway.activityId,\n        requestPayloadLengthInBytes: gateway.requestPayloadLengthInBytes,\n        responsePayloadLengthInBytes: gateway.responsePayloadLengthInBytes,\n        startTimeUTCInMs: gateway.startTimeUTCInMs,\n        operationType: gateway.operationType,\n        resourceType: gateway.resourceType,\n        durationInMs: gateway.durationInMs,\n        metaDataType: metadataType,\n      }),\n    );\n\n    // Copy child nodes's metadata lookups to parent's metadata lookups.\n    childDiagnostics.metadataLookups.forEach((lookup) => this.metadataLookups.push(lookup));\n\n    // Copy child nodes's failed attempts to parent's failed attempts.\n    childDiagnostics.failedAttempts.forEach((lookup) => this.failedAttempts.push(lookup));\n  }\n\n  public getClientSideStats(\n    endTimeUTCInMs: number = getCurrentTimestampInMs(),\n  ): ClientSideRequestStatistics {\n    return {\n      requestStartTimeUTCInMs: this.requestStartTimeUTCinMs,\n      requestDurationInMs: endTimeUTCInMs - this.requestStartTimeUTCinMs,\n      totalRequestPayloadLengthInBytes: this.getTotalRequestPayloadLength(),\n      totalResponsePayloadLengthInBytes: this.getTotalResponsePayloadLength(),\n      locationEndpointsContacted: [...this.locationEndpointsContacted.values()],\n      metadataDiagnostics: {\n        metadataLookups: [...this.metadataLookups],\n      },\n      retryDiagnostics: {\n        failedAttempts: [...this.failedAttempts],\n      },\n      gatewayStatistics: this.gaterwayStatistics,\n    };\n  }\n\n  public getTotalRequestPayloadLength(): number {\n    let totalRequestPayloadLength = 0;\n    this.gaterwayStatistics.forEach(\n      (req) => (totalRequestPayloadLength += req.requestPayloadLengthInBytes),\n    );\n    this.metadataLookups.forEach(\n      (req) => (totalRequestPayloadLength += req.requestPayloadLengthInBytes),\n    );\n    this.failedAttempts.forEach(\n      (req) => (totalRequestPayloadLength += req.requestPayloadLengthInBytes),\n    );\n    return totalRequestPayloadLength;\n  }\n\n  public getTotalResponsePayloadLength(): number {\n    let totalResponsePayloadLength = 0;\n    this.gaterwayStatistics.forEach(\n      (req) => (totalResponsePayloadLength += req.responsePayloadLengthInBytes),\n    );\n    this.metadataLookups.forEach(\n      (req) => (totalResponsePayloadLength += req.responsePayloadLengthInBytes),\n    );\n    this.failedAttempts.forEach(\n      (req) => (totalResponsePayloadLength += req.responsePayloadLengthInBytes),\n    );\n    return totalResponsePayloadLength;\n  }\n\n  public recordEndpointResolution(location: string): void {\n    this.locationEndpointsContacted.add(location);\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}